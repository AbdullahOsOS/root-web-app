<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <title>My Consumption</title>
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/style.css}">
    <link rel='icon' th:href="@{images/icon.png}">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css}" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>
<body>
<nav>
    <ul>
        <li> <a href ="/me">MY PROFILE</a></li>
        <li> <a class="active" href="#">VIEW CONSUMPTION</a></li>
        <li> <a href="/me/bill">GENERATE BILL</a></li>
    </ul>
    <div id="logoutDiv">
        <form action="#" th:action="@{/logout}"method="POST">
            <button type="submit" class="btn btn-secondary float-right" id="logout-btn">Logout</button>
        </form>
    </div>
</nav>
<section class="backgroundimg">
    <center>
        <div class="date" data-aos="fade-up" data-aos-once="false">
            <table>
                <tr>
                    <td colspan="2"><p><font color="white">Please, Choose a start date and end date to view your consumption: </font></p></td>
                </tr>
                <tr>
                    <td><font color="white"><p>Start date : </p></font></td>
                    <td><input class="calender" type="date" id="date-picker-start"></td>
                </tr>
                <br>
                <br>
                <tr>
                    <td><font color="white"><p>End date : </p></font></td>
                    <td><input class="calender" type="date" id="date-picker-end"></td>
                </tr>
                <tr>
                    <td colspan="2"><button class="hero-btn" onclick="sendRequest()">show down</button></td>
                </tr>
            </table>
        </div>
    </center>
    <br>
    <hr>
    <br>
    <!-----------------------------------------------------------Chart--------------------------------------------------------------------->
    <div class="card text-center m-5">
        <div class="card-header">
            <h2>My Chart</h2>
        </div>
        <canvas id="myChart"></canvas>
    </div>
    <footer>
        <div class="footer-content">
            <h3>Next Generation Smart Grid Meter</h3>
            <p>Electricity can transform people's lives, not just economically but also socially</p>
            <ul class="socials">
                <li><a href="https://www.facebook.com/ElsewedyElectric/"><i class="fa fa-facebook"></i></a></li>
                <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                <li><a href="#"><i class="fa fa-youtube"></i></a></li>
                <li><a href="#"><i class="fa fa-linkedin-square"></i></a></li>
            </ul>
        </div>
        <div class="footer-bottom">
            <p>copyright &copy; 2022 ElSewedy Electric</p>
        </div>
    </footer>



    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script>
var employeelabel = [], employeesalary = [], employeeage = [];
var start_global;
var end_global;
async function dummyChart(){

await getdata();
let ctx = document.getElementById('myChart').getContext('2d');
let chart =new Chart(ctx,{
type:'bar',
data:{
labels:employeelabel,
datasets:[{
label:'My amount for this week',
backgroundColor:'#6FB2D2',
borderColor:'#6FB2D2',
data: employeesalary,
},
{
label:'My consumed energy for this week',
backgroundColor:'#fa8c7f',
borderColor:'#fa8c7f',
data:employeeage,
}
]
},
options:{
tooltip:{
mode: 'index'
}
}
});
}
async function getdata(){

const apiurl = 'https://rooot.azurewebsites.net/reading/get/period?userId=30&start='+start_global+'&end='+end_global;
const response = await fetch(apiurl);
const barChartData = await response.json();

const salary = barChartData.map( (x) => x.amount);
const age = barChartData.map( (x) => x.energy);
const day = barChartData.map( (x) => x.date);

console.log(salary,age,day);

employeelabel = day;
employeesalary = salary;
employeeage = age;

}
function sendRequest(){
populateDate(); //dates: [start, end]
dummyChart();

}
function populateDate(){
var start = new Date(document.getElementById("date-picker-start").value);
var year = start.getFullYear();
var month = start.getMonth()+1;
if(month<9) month = '0'+month;
var day = String(start.getDate()).padStart(2,'0');
var startDate = year + '-' + month + '-' + day;

var end = new Date(document.getElementById("date-picker-end").value);
year = start.getFullYear();
month = start.getMonth()+1;
if(month<9) month = '0'+month;

day = String(end.getDate()).padStart(2,'0');
var endDate = year + '-' + month + '-' + day;

start_global = startDate;
end_global = endDate;
console.log(start_global);
}

</script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"> </script>
    <script>
AOS.init({
duration:1000
});
</script>


</body>